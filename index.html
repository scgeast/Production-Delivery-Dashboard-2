<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Concrete Delivery Monitoring</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f5f7f9; color: #333; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    header { background: linear-gradient(135deg, #2c3e50, #1a2530); color: white; padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 6px 12px rgba(0,0,0,.15); text-align: center; }
    header h1 { display:flex; gap:10px; align-items:center; justify-content:center; }

    /* GLOBAL FILTER BAR (applies to both tabs) */
    .global-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; background: white; padding: 14px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,.08); margin-bottom: 18px; position: sticky; top: 8px; z-index: 5; }
    .filter-group label { display:block; margin-bottom:6px; font-weight:600; color:#2c3e50; }
    .filter-group input, .filter-group select { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa; }
    .filter-actions { display:flex; gap:10px; align-items:end; }
    .btn { padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform .2s, box-shadow .2s, opacity .2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { opacity:.95; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,.12); }
    .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; }
    .btn-secondary { background: linear-gradient(135deg, #7f8c8d, #95a5a6); color: #fff; }
    .btn-success { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; }
    .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }

    /* Tabs */
    .tabs { display:flex; background:white; border-radius: 8px; overflow:hidden; box-shadow: 0 4px 6px rgba(0,0,0,.1); margin-bottom: 16px; }
    .tab-button { flex:1; padding: 14px; text-align:center; background:#ecf0f1; border:none; cursor:pointer; font-size:16px; font-weight:700; transition: background-color .3s; }
    .tab-button.active { background:#3498db; color:white; }
    .tab-button:hover { background:#dfe4ea; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Single-row entry form */
    .entry-form { background:white; border-radius:12px; padding: 16px; box-shadow: 0 6px 12px rgba(0,0,0,.1); margin-bottom: 16px; }
    .entry-row { display:grid; grid-template-columns: repeat(8, 1fr); gap: 10px; align-items: end; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; color:#2c3e50; }
    .form-group input, .form-group select { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa; }

    /* Table */
    table { width:100%; border-collapse: collapse; background:white; border-radius: 10px; overflow:hidden; box-shadow: 0 4px 6px rgba(0,0,0,.1); margin: 14px 0; }
    th, td { padding: 12px 14px; text-align:left; border-bottom:1px solid #eee; }
    th { background:#2c3e50; color:#fff; }
    tr:hover { background:#f7f9fb; }
    .action-cell { display:flex; gap:8px; }

    /* Cards & dashboard */
    .card { background:white; border-radius:12px; padding: 16px; box-shadow: 0 6px 12px rgba(0,0,0,.1); margin-bottom: 16px; }
    .dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 16px; margin-bottom: 16px; }
    .stat-card { background: linear-gradient(135deg, #ffffff, #f8f9fa); border-radius:12px; padding:16px; box-shadow: 0 6px 12px rgba(0,0,0,.1); text-align:center; border-left:5px solid; }
    .stat-card:nth-child(1){ border-left-color:#3498db; }
    .stat-card:nth-child(2){ border-left-color:#2ecc71; }
    .stat-card:nth-child(3){ border-left-color:#e74c3c; }
    .stat-card:nth-child(4){ border-left-color:#f39c12; }
    .stat-card:nth-child(5){ border-left-color:#9b59b6; }
    .stat-card h3 { color:#7f8c8d; font-size:.95rem; margin-bottom:6px; }
    .stat-card .value { font-size: 2rem; font-weight: 800; margin: 6px 0; }

    .charts-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(420px,1fr)); gap:16px; }
    .chart-card { background:white; border-radius:12px; padding:16px; box-shadow: 0 6px 12px rgba(0,0,0,.1); }
    .chart-container { position:relative; height:300px; width:100%; }

    .summary-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px,1fr)); gap:16px; margin-top: 10px; }
    .plant-summary { background: linear-gradient(135deg,#fff,#f8f9fa); border-radius:12px; padding:16px; box-shadow:0 6px 12px rgba(0,0,0,.1); }
    .plant-summary h2 { color:#2c3e50; padding-bottom:8px; border-bottom:2px solid #ecf0f1; margin-bottom:10px; }
    .progress-bar { height:18px; background:#ecf0f1; border-radius: 9px; margin: 12px 0; overflow:hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,.1); }
    .progress-fill { height:100%; border-radius: 9px; transition: width .5s ease-in-out; }
    .denpasar-progress { background: linear-gradient(90deg, #3498db, #2c3e50); }
    .gianyar-progress { background: linear-gradient(90deg, #e74c3c, #c0392b); }
    .percentage { display:flex; justify-content: space-between; font-weight: 700; }
    .percentage .delivered { color:#2ecc71; }
    .percentage .pending { color:#e74c3c; }

    .last-update { text-align:center; margin-top: 10px; font-style: italic; color:#7f8c8d; }

    .notification { position: fixed; top:20px; right:20px; padding: 14px 16px; background:#2ecc71; color:white; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,.15); display:none; z-index: 1000; }

    @media (max-width: 900px) {
      .entry-row { grid-template-columns: 1fr 1fr; }
      .charts-container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fa-solid fa-industry"></i> Concrete Delivery Monitoring</h1>
      <p>Last update: <span id="last-update">--/--/---- --:--</span></p>
    </header>

    <!-- GLOBAL FILTERS (apply to table + dashboard) -->
    <section class="global-filters" id="global-filters">
      <div class="filter-group">
        <label for="from-date">From Date</label>
        <input type="date" id="from-date" />
      </div>
      <div class="filter-group">
        <label for="to-date">To Date</label>
        <input type="date" id="to-date" />
      </div>
      <div class="filter-group">
        <label for="filter-plant">Plant</label>
        <select id="filter-plant">
          <option value="all">All Plants</option>
          <option value="Denpasar 2">Denpasar 2</option>
          <option value="Gianyar">Gianyar</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-status">Status</label>
        <select id="filter-status">
          <option value="all">All Status</option>
          <option value="delivered">Delivered</option>
          <option value="pending">Pending</option>
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" id="apply-filters"><i class="fa-solid fa-filter"></i> Apply Filters</button>
        <button class="btn btn-secondary" id="reset-filters"><i class="fa-solid fa-rotate-right"></i> Reset</button>
      </div>
    </section>

    <div class="tabs">
      <button class="tab-button active" data-tab="entry">Data Entry</button>
      <button class="tab-button" data-tab="dashboard">Dashboard</button>
    </div>

    <!-- ENTRY TAB -->
    <div id="entry-tab" class="tab-content active">
      <section class="entry-form">
        <h2><i class="fa-solid fa-pen-to-square"></i> Single-row Data Entry</h2>
        <div class="entry-row">
          <div class="form-group">
            <label for="date-input">Date</label>
            <input type="date" id="date-input" />
          </div>
          <div class="form-group">
            <label for="plant-input">Plant</label>
            <select id="plant-input">
              <option value="Denpasar 2">Denpasar 2</option>
              <option value="Gianyar">Gianyar</option>
            </select>
          </div>
          <div class="form-group">
            <label for="site-no">Site No</label>
            <input type="text" id="site-no" placeholder="Enter Site No" />
          </div>
          <div class="form-group">
            <label for="site-name">Site Name</label>
            <input type="text" id="site-name" placeholder="Enter Site Name" />
          </div>
          <div class="form-group">
            <label for="qty-order">Qty Order (m³)</label>
            <input type="number" id="qty-order" min="0" value="0" />
          </div>
          <div class="form-group">
            <label for="qty-delivery">Qty Delivered (m³)</label>
            <input type="number" id="qty-delivery" min="0" value="0" />
          </div>
          <div class="form-group">
            <label for="qty-cancel">Qty Cancel (m³)</label>
            <input type="number" id="qty-cancel" min="0" value="0" />
          </div>
          <div class="form-group">
            <label for="qty-remain">Qty Remain (m³)</label>
            <input type="number" id="qty-remain" value="0" readonly />
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:10px;">
          <button class="btn btn-success" id="add-data"><i class="fa-solid fa-plus"></i> Add Row</button>
          <button class="btn btn-danger" id="clear-all"><i class="fa-solid fa-trash"></i> Clear All</button>
        </div>
      </section>

      <section class="card">
        <h2><i class="fa-solid fa-database"></i> Data Table</h2>
        <table id="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Plant</th>
              <th>Site No</th>
              <th>Site Name</th>
              <th>Qty Order</th>
              <th>Qty Delivered</th>
              <th>Qty Remain</th>
              <th>Qty Cancel</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </section>
    </div>

    <!-- DASHBOARD TAB -->
    <div id="dashboard-tab" class="tab-content">
      <section class="dashboard">
        <div class="stat-card">
          <h3><i class="fa-solid fa-cubes"></i> Total Ordered</h3>
          <div class="value" id="total-ordered">0 m³</div>
          <p>Total ordered volume</p>
        </div>
        <div class="stat-card">
          <h3><i class="fa-solid fa-truck"></i> Delivered</h3>
          <div class="value" id="total-delivered">0 m³</div>
          <p>Total delivered volume</p>
        </div>
        <div class="stat-card">
          <h3><i class="fa-regular fa-clock"></i> Pending</h3>
          <div class="value" id="total-pending">0 m³</div>
          <p>Volume not delivered yet</p>
        </div>
        <div class="stat-card">
          <h3><i class="fa-solid fa-building"></i> Projects</h3>
          <div class="value" id="total-projects">0</div>
          <p>Unique projects</p>
        </div>
        <div class="stat-card">
          <h3><i class="fa-solid fa-hourglass-half"></i> Projects Pending</h3>
          <div class="value" id="projects-pending">0</div>
          <p>Projects with remaining qty</p>
        </div>
      </section>

      <div class="charts-container">
        <div class="chart-card">
          <h2><i class="fa-solid fa-chart-pie"></i> Volume Distribution</h2>
          <div class="chart-container"><canvas id="volumeChart"></canvas></div>
        </div>
        <div class="chart-card">
          <h2><i class="fa-solid fa-chart-bar"></i> By Plant</h2>
          <div class="chart-container"><canvas id="plantChart"></canvas></div>
        </div>
      </div>

      <section class="summary-cards">
        <div class="plant-summary">
          <h2><i class="fa-solid fa-industry"></i> Denpasar 2</h2>
          <p><strong>Ordered:</strong> <span id="denpasar-ordered">0</span> m³</p>
          <p><strong>Delivered:</strong> <span id="denpasar-delivered">0</span> m³</p>
          <p><strong>Pending:</strong> <span id="denpasar-pending">0</span> m³</p>
          <p><strong>Projects Pending:</strong> <span id="denpasar-projects-pending">0</span></p>
          <div class="progress-bar"><div class="progress-fill denpasar-progress" id="denpasar-progress" style="width:0%"></div></div>
          <div class="percentage"><span class="delivered" id="denpasar-delivered-pct">Delivered: 0%</span><span class="pending" id="denpasar-pending-pct">Pending: 100%</span></div>
        </div>
        <div class="plant-summary">
          <h2><i class="fa-solid fa-industry"></i> Gianyar</h2>
          <p><strong>Ordered:</strong> <span id="gianyar-ordered">0</span> m³</p>
          <p><strong>Delivered:</strong> <span id="gianyar-delivered">0</span> m³</p>
          <p><strong>Pending:</strong> <span id="gianyar-pending">0</span> m³</p>
          <p><strong>Projects Pending:</strong> <span id="gianyar-projects-pending">0</span></p>
          <div class="progress-bar"><div class="progress-fill gianyar-progress" id="gianyar-progress" style="width:0%"></div></div>
          <div class="percentage"><span class="delivered" id="gianyar-delivered-pct">Delivered: 0%</span><span class="pending" id="gianyar-pending-pct">Pending: 100%</span></div>
        </div>
      </section>

      <div class="last-update"><p>Auto-updates using your laptop time. Last update: <span id="update-time">--/--/---- --:--</span></p></div>
    </div>

    <div class="notification" id="notification">Saved!</div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Init storage keys
      const STORAGE_KEY = 'deliveryData';
      const UPDATE_KEY = 'lastUpdate';
      if (!localStorage.getItem(STORAGE_KEY)) localStorage.setItem(STORAGE_KEY, JSON.stringify([]));

      // Elements
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      const notification = document.getElementById('notification');
      const lastUpdateEl = document.getElementById('last-update');

      // Entry inputs
      const dateInput = document.getElementById('date-input');
      const plantInput = document.getElementById('plant-input');
      const siteNoInput = document.getElementById('site-no');
      const siteNameInput = document.getElementById('site-name');
      const qtyOrderInput = document.getElementById('qty-order');
      const qtyDeliveryInput = document.getElementById('qty-delivery');
      const qtyCancelInput = document.getElementById('qty-cancel');
      const qtyRemainInput = document.getElementById('qty-remain');
      const addBtn = document.getElementById('add-data');
      const clearAllBtn = document.getElementById('clear-all');

      // Table
      const tableBody = document.getElementById('table-body');

      // Global filters
      const fromDate = document.getElementById('from-date');
      const toDate = document.getElementById('to-date');
      const filterPlant = document.getElementById('filter-plant');
      const filterStatus = document.getElementById('filter-status');
      const applyFiltersBtn = document.getElementById('apply-filters');
      const resetFiltersBtn = document.getElementById('reset-filters');

      // Dashboard els
      const totalOrderedEl = document.getElementById('total-ordered');
      const totalDeliveredEl = document.getElementById('total-delivered');
      const totalPendingEl = document.getElementById('total-pending');
      const totalProjectsEl = document.getElementById('total-projects');
      const projectsPendingEl = document.getElementById('projects-pending');

      const denpasarOrderedEl = document.getElementById('denpasar-ordered');
      const denpasarDeliveredEl = document.getElementById('denpasar-delivered');
      const denpasarPendingEl = document.getElementById('denpasar-pending');
      const denpasarProjectsPendingEl = document.getElementById('denpasar-projects-pending');
      const denpasarProgress = document.getElementById('denpasar-progress');
      const denpasarDeliveredPct = document.getElementById('denpasar-delivered-pct');
      const denpasarPendingPct = document.getElementById('denpasar-pending-pct');

      const gianyarOrderedEl = document.getElementById('gianyar-ordered');
      const gianyarDeliveredEl = document.getElementById('gianyar-delivered');
      const gianyarPendingEl = document.getElementById('gianyar-pending');
      const gianyarProjectsPendingEl = document.getElementById('gianyar-projects-pending');
      const gianyarProgress = document.getElementById('gianyar-progress');
      const gianyarDeliveredPct = document.getElementById('gianyar-delivered-pct');
      const gianyarPendingPct = document.getElementById('gianyar-pending-pct');

      // Charts
      let volumeChartInstance = null;
      let plantChartInstance = null;

      // Helpers
      function nowString() {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2,'0');
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const yyyy = now.getFullYear();
        const hh = String(now.getHours()).padStart(2,'0');
        const min = String(now.getMinutes()).padStart(2,'0');
        return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
      }

      function showNotification(message, isError=false){
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.backgroundColor = isError ? '#e74c3c' : '#2ecc71';
        setTimeout(()=> notification.style.display='none', 2500);
      }

      function getAllData(){
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
        catch { return []; }
      }
      function setAllData(data){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        const stamp = nowString();
        localStorage.setItem(UPDATE_KEY, stamp);
        lastUpdateEl.textContent = stamp;
        return stamp;
      }

      function calcRemain(){
        const order = parseFloat(qtyOrderInput.value) || 0;
        const delivered = parseFloat(qtyDeliveryInput.value) || 0;
        const cancel = parseFloat(qtyCancelInput.value) || 0;
        const remain = Math.max(order - delivered - cancel, 0);
        qtyRemainInput.value = remain;
      }
      qtyOrderInput.addEventListener('input', calcRemain);
      qtyDeliveryInput.addEventListener('input', calcRemain);
      qtyCancelInput.addEventListener('input', calcRemain);

      function formatDateDisplay(iso){
        const d = new Date(iso);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      function recordMatchesFilters(rec){
        // Date range
        const recDate = new Date(rec.date);
        if (fromDate.value){
          const from = new Date(fromDate.value);
          if (recDate < from) return false;
        }
        if (toDate.value){
          const to = new Date(toDate.value);
          to.setHours(23,59,59,999);
          if (recDate > to) return false;
        }
        // Plant
        if (filterPlant.value !== 'all' && rec.plant !== filterPlant.value) return false;
        // Status
        if (filterStatus.value !== 'all'){
          const isPending = rec.qtyRemain > 0;
          if (filterStatus.value === 'pending' && !isPending) return false;
          if (filterStatus.value === 'delivered' && isPending) return false;
        }
        return true;
      }

      function getFilteredData(){
        return getAllData().filter(recordMatchesFilters);
      }

      function renderTable(){
        const data = getFilteredData();
        tableBody.innerHTML = '';
        if (data.length === 0){
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="9" style="text-align:center; padding:18px;">No data. Use the entry row above to add records.</td>`;
          tableBody.appendChild(row);
          return;
        }
        data.forEach((rec, idx) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatDateDisplay(rec.date)}</td>
            <td>${rec.plant}</td>
            <td>${rec.siteNo}</td>
            <td>${rec.siteName}</td>
            <td>${rec.qtyOrder} m³</td>
            <td>${rec.qtyDelivery} m³</td>
            <td>${rec.qtyRemain} m³</td>
            <td>${rec.qtyCancel} m³</td>
            <td class="action-cell">
              <button class="btn btn-danger" data-id="${rec.id}"><i class="fa-solid fa-trash"></i></button>
            </td>`;
          // attach delete handler
          row.querySelector('button').addEventListener('click', () => deleteRecord(rec.id));
          tableBody.appendChild(row);
        });
      }

      function deleteRecord(id){
        if (!confirm('Delete this record?')) return;
        const all = getAllData();
        const next = all.filter(r => r.id !== id);
        setAllData(next);
        renderEverything();
        showNotification('Record deleted');
      }

      // Stats
      function calculateStats(data){
        let totalOrdered = 0, totalDelivered = 0, totalPending = 0;
        const uniqueProjects = new Set();
        const projectsPending = new Set();

        let dOrdered=0,dDelivered=0,dPending=0,dProjPend=0;
        let gOrdered=0,gDelivered=0,gPending=0,gProjPend=0;

        data.forEach(r => {
          totalOrdered += r.qtyOrder;
          totalDelivered += r.qtyDelivery;
          totalPending += r.qtyRemain;
          uniqueProjects.add(r.siteNo);
          if (r.qtyRemain > 0) projectsPending.add(r.siteNo);

          if (r.plant === 'Denpasar 2'){
            dOrdered += r.qtyOrder; dDelivered += r.qtyDelivery; dPending += r.qtyRemain; if (r.qtyRemain>0) dProjPend++;
          } else if (r.plant === 'Gianyar'){
            gOrdered += r.qtyOrder; gDelivered += r.qtyDelivery; gPending += r.qtyRemain; if (r.qtyRemain>0) gProjPend++;
          }
        });

        return { totalOrdered, totalDelivered, totalPending, totalProjects: uniqueProjects.size, projectsPending: projectsPending.size,
          dOrdered,dDelivered,dPending,dProjPend, gOrdered,gDelivered,gPending,gProjPend };
      }

      function updateDashboardUI(stats){
        totalOrderedEl.textContent = stats.totalOrdered + ' m³';
        totalDeliveredEl.textContent = stats.totalDelivered + ' m³';
        totalPendingEl.textContent = stats.totalPending + ' m³';
        totalProjectsEl.textContent = stats.totalProjects;
        projectsPendingEl.textContent = stats.projectsPending;

        denpasarOrderedEl.textContent = stats.dOrdered;
        denpasarDeliveredEl.textContent = stats.dDelivered;
        denpasarPendingEl.textContent = stats.dPending;
        denpasarProjectsPendingEl.textContent = stats.dProjPend;

        const dPct = stats.dOrdered>0 ? (stats.dDelivered/stats.dOrdered)*100 : 0;
        denpasarProgress.style.width = dPct + '%';
        denpasarDeliveredPct.textContent = `Delivered: ${dPct.toFixed(0)}%`;
        denpasarPendingPct.textContent = `Pending: ${(100-dPct).toFixed(0)}%`;

        gianyarOrderedEl.textContent = stats.gOrdered;
        gianyarDeliveredEl.textContent = stats.gDelivered;
        gianyarPendingEl.textContent = stats.gPending;
        gianyarProjectsPendingEl.textContent = stats.gProjPend;

        const gPct = stats.gOrdered>0 ? (stats.gDelivered/stats.gOrdered)*100 : 0;
        gianyarProgress.style.width = gPct + '%';
        gianyarDeliveredPct.textContent = `Delivered: ${gPct.toFixed(0)}%`;
        gianyarPendingPct.textContent = `Pending: ${(100-gPct).toFixed(0)}%`;
      }

      function initCharts(stats){
        const volCtx = document.getElementById('volumeChart').getContext('2d');
        if (volumeChartInstance) volumeChartInstance.destroy();
        volumeChartInstance = new Chart(volCtx, {
          type:'pie',
          data:{ labels:['Delivered','Pending'], datasets:[{ data:[stats.totalDelivered, stats.totalPending], backgroundColor:['#2ecc71','#e74c3c'], borderWidth:0 }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' }, title:{ display:true, text:'Concrete Volume Distribution' } } }
        });

        const plantCtx = document.getElementById('plantChart').getContext('2d');
        if (plantChartInstance) plantChartInstance.destroy();
        plantChartInstance = new Chart(plantCtx, {
          type:'bar',
          data:{
            labels: ['Denpasar 2','Gianyar'],
            datasets:[
              { label:'Ordered', data:[stats.dOrdered, stats.gOrdered], backgroundColor:'#3498db' },
              { label:'Delivered', data:[stats.dDelivered, stats.gDelivered], backgroundColor:'#2ecc71' },
              { label:'Pending', data:[stats.dPending, stats.gPending], backgroundColor:'#e74c3c' },
            ]
          },
          options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ grid:{ display:false } }, y:{ beginAtZero:true, title:{ display:true, text:'Volume (m³)' } } }, plugins:{ legend:{ position:'bottom' }, title:{ display:true, text:'Plant Performance' } } }
        });
      }

      function renderDashboard(){
        const filtered = getFilteredData();
        const stats = calculateStats(filtered);
        updateDashboardUI(stats);
        initCharts(stats);
      }

      function renderEverything(){
        renderTable();
        renderDashboard();
        document.getElementById('update-time').textContent = nowString();
      }

      // Tab switching
      tabButtons.forEach(btn => btn.addEventListener('click', function(){
        const tabId = this.getAttribute('data-tab');
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
        renderDashboard();
      }));

      // Apply & reset filters
      applyFiltersBtn.addEventListener('click', () => { renderEverything(); showNotification('Filters applied'); });
      resetFiltersBtn.addEventListener('click', () => {
        fromDate.value = ''; toDate.value = ''; filterPlant.value = 'all'; filterStatus.value = 'all';
        renderEverything(); showNotification('Filters reset');
      });

      // Add data
      addBtn.addEventListener('click', () => {
        if (!siteNoInput.value || !siteNameInput.value){ showNotification('Site No and Site Name are required', true); return; }
        const all = getAllData();
        const rec = {
          id: crypto.randomUUID(),
          date: dateInput.value || new Date().toISOString().slice(0,10),
          plant: plantInput.value,
          siteNo: siteNoInput.value.trim(),
          siteName: siteNameInput.value.trim(),
          qtyOrder: parseFloat(qtyOrderInput.value)||0,
          qtyDelivery: parseFloat(qtyDeliveryInput.value)||0,
          qtyCancel: parseFloat(qtyCancelInput.value)||0,
          qtyRemain: parseFloat(qtyRemainInput.value)||0,
        };
        all.push(rec);
        setAllData(all);
        // Clear minimal
        siteNoInput.value=''; siteNameInput.value=''; qtyOrderInput.value='0'; qtyDeliveryInput.value='0'; qtyCancelInput.value='0'; qtyRemainInput.value='0';
        renderEverything();
        showNotification('Row added');
      });

      // Clear all
      clearAllBtn.addEventListener('click', () => {
        if (!confirm('Delete ALL data? This cannot be undone.')) return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
        setAllData([]);
        renderEverything();
        showNotification('All data cleared');
      });

      // Initial values
      // Default today for date input
      const todayIso = new Date().toISOString().slice(0,10);
      dateInput.value = todayIso;
      const savedUpdate = localStorage.getItem(UPDATE_KEY);
      lastUpdateEl.textContent = savedUpdate || nowString();

      // First render
      renderEverything();

      // Live clock for footer
      function tick(){ document.getElementById('update-time').textContent = nowString(); }
      tick();
      setInterval(tick, 60000);
    });
  </script>
</body>
</html>
